#!/bin/bash
# ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
# ‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë –ù–ê–°–¢–†–û–ô–ö–ò ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñà
# ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
BOLD="\033[1m"
RED="\033[1;31m"
GREEN="\033[1;32m"
YELLOW="\033[1;33m"
BLUE="\033[1;34m"
RESET="\033[0m"
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –û–°–ù–û–í–ù–´–ï –ü–ê–†–ê–ú–ï–¢–†–´ –ó–ê–ü–ò–°–ò
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
SPLIT_TIME=1800               # –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (30 –º–∏–Ω—É—Ç)
OUTPUT_DIR="/root/arec"       # –ü–∞–ø–∫–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–ø–∏—Å–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
LOG_FILE="/root/arec/arec.log" # –§–∞–π–ª –¥–ª—è –∑–∞–ø–∏—Å–∏ –ª–æ–≥–æ–≤ —Ä–∞–±–æ—Ç—ã —Å–∫—Ä–∏–ø—Ç–∞
SAMPLE_RATE=48000             # –ß–∞—Å—Ç–æ—Ç–∞ –¥–∏—Å–∫—Ä–µ—Ç–∏–∑–∞—Ü–∏–∏ –∞—É–¥–∏–æ (–ì—Ü)
SAMPLE_FORMAT="S24_3LE"       # –§–æ—Ä–º–∞—Ç —Å–µ–º–ø–ª–∏—Ä–æ–≤–∞–Ω–∏—è
MIC="default"                 # –ò—Å—Ç–æ—á–Ω–∏–∫ –∑–≤—É–∫–∞ (default = –º–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –ù–ê–°–¢–†–û–ô–ö–ò –ö–û–î–ò–†–û–í–ê–ù–ò–Ø –ê–£–î–ò–û
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
AUDIO_FORMAT="opus"           # –§–æ—Ä–º–∞—Ç –∞—É–¥–∏–æ: aac, opus, mp3
BITRATE=64                    # –ë–∏—Ç—Ä–µ–π—Ç –∞—É–¥–∏–æ –≤ –∫–±–∏—Ç/—Å
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –ù–ê–°–¢–†–û–ô–ö–ò –û–ë–õ–ê–ß–ù–û–ì–û –•–†–ê–ù–ò–õ–ò–©–ê
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
CLOUD_SERVICE="google"        # –û–±–ª–∞—á–Ω—ã–π —Å–µ—Ä–≤–∏—Å: google, yandex, none (–±–µ–∑ –æ–±–ª–∞–∫–∞)
DELETE_AFTER_UPLOAD=true      # –£–¥–∞–ª—è—Ç—å —Ñ–∞–π–ª—ã –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –≤—ã–≥—Ä—É–∑–∫–∏
RETRY_DELAY=300               # –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏ –∑–∞–≥—Ä—É–∑–∫–∏ (—Å–µ–∫—É–Ω–¥—ã)
MAX_RETRIES=15                # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏
CONNECTIVITY_CHECK_INTERVAL=180 # –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (—Å–µ–∫—É–Ω–¥—ã)
PENDING_DIR="/root/arec/pending" # –ü–∞–ø–∫–∞ –¥–ª—è —Ñ–∞–π–ª–æ–≤ –≤ –æ—á–µ—Ä–µ–¥–∏ –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É
MAX_STORAGE_MB=40960          # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ (–ú–ë)
CONNECTIVITY_TIMEOUT=10       # –¢–∞–π–º–∞—É—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ—Ç–µ–≤–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (—Å–µ–∫—É–Ω–¥—ã)
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –ù–ê–°–¢–†–û–ô–ö–ò –ê–î–ê–ü–¢–ò–í–ù–û–ô –°–ï–¢–ò
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
MAX_PARALLEL_UPLOADS=3        # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–≥—Ä—É–∑–æ–∫
NETWORK_SPEED_THRESHOLD=100   # –ü–æ—Ä–æ–≥ –º–µ–¥–ª–µ–Ω–Ω–æ–π —Å–µ—Ç–∏ (–º—Å ping)
SLOW_NETWORK_RETRY_DELAY=600  # –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –º–µ–¥–ª–µ–Ω–Ω–æ–π —Å–µ—Ç–∏ (—Å–µ–∫—É–Ω–¥—ã)
SLOW_NETWORK_MAX_RETRIES=5    # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –¥–ª—è –º–µ–¥–ª–µ–Ω–Ω–æ–π —Å–µ—Ç–∏
QUEUE_WARNING_THRESHOLD=80    # –ü–æ—Ä–æ–≥ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ —Ä–∞–∑–º–µ—Ä–µ –æ—á–µ—Ä–µ–¥–∏ (%)
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –ù–ê–°–¢–†–û–ô–ö–ò GOOGLE DRIVE
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
GOOGLE_REMOTE="google.drive"  # –ò–º—è —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –≤ rclone
GOOGLE_DIR="/Recordings"      # –ü–∞–ø–∫–∞ –Ω–∞ Google Drive –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –ù–ê–°–¢–†–û–ô–ö–ò –Ø–ù–î–ï–ö–°.–î–ò–°–ö
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
YANDEX_REMOTE="yandex.disk"   # –ò–º—è —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –≤ rclone
YANDEX_DIR="/Recordings"      # –ü–∞–ø–∫–∞ –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –†–ê–°–ü–ò–°–ê–ù–ò–ï –ó–ê–ü–ò–°–ò (–û–ü–¶–ò–û–ù–ê–õ–¨–ù–û)
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
RECORDING_SCHEDULE_ENABLED=true  # false - —Ä–∞–±–æ—Ç–∞—Ç—å –≤—Å–µ–≥–¥–∞, true = —Ä–∞–±–æ—Ç–∞—Ç—å —Ç–æ–ª—å–∫–æ –≤ –∑–∞–¥–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
RECORDING_START_HOUR=6           # –ß–∞—Å –Ω–∞—á–∞–ª–∞ (0‚Äì23)
RECORDING_END_HOUR=22            # –ß–∞—Å –æ–∫–æ–Ω—á–∞–Ω–∏—è (–∑–∞–ø–∏—Å—å –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ—Ç —á–∞—Å)
# ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
# ‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë –§–£–ù–ö–¶–ò–ò ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñà
# ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà

# (–í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ‚Äî –∫–æ–ø–∏—Ä—É–µ–º –∏—Ö –∫–∞–∫ –µ—Å—Ç—å –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞)

# –§—É–Ω–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ –æ–±–ª–∞—á–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö)
select_cloud_service() {
    if [ -n "$CLOUD_SERVICE" ]; then
        printf "${GREEN}‚úî –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å: $(get_cloud_name)${RESET}\n"
        return
    fi
    printf "${BOLD}${BLUE}‚òÅ –í—ã–±–µ—Ä–∏—Ç–µ –æ–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ:${RESET}\n"
    printf "${YELLOW}1)${RESET} Google Drive\n"
    printf "${YELLOW}2)${RESET} –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫\n"
    printf "${YELLOW}3)${RESET} –ë–µ–∑ –æ–±–ª–∞—á–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞\n"
    printf "\n${BOLD}–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä (1-3): ${RESET}"
    while true; do
        read -r choice
        case "$choice" in
            1)
                CLOUD_SERVICE="google"
                printf "${GREEN}‚úî –í—ã–±—Ä–∞–Ω Google Drive${RESET}\n"
                break
                ;;
            2)
                CLOUD_SERVICE="yandex"
                printf "${GREEN}‚úî –í—ã–±—Ä–∞–Ω –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫${RESET}\n"
                break
                ;;
            3)
                CLOUD_SERVICE="none"
                printf "${GREEN}‚úî –û–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ${RESET}\n"
                break
                ;;
            *)
                printf "${RED}‚úñ –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä. –í–≤–µ–¥–∏—Ç–µ 1, 2 –∏–ª–∏ 3: ${RESET}"
                ;;
        esac
    done
}

# –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –æ–±–ª–∞—á–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
get_cloud_settings() {
    case "$CLOUD_SERVICE" in
        "google")
            echo "$GOOGLE_REMOTE:$GOOGLE_DIR"
            ;;
        "yandex")
            echo "$YANDEX_REMOTE:$YANDEX_DIR"
            ;;
        *)
            echo ""
            ;;
    esac
}

# –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–º–µ–Ω–∏ –æ–±–ª–∞—á–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
get_cloud_name() {
    case "$CLOUD_SERVICE" in
        "google")
            echo "Google Drive"
            ;;
        "yandex")
            echo "–Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫"
            ;;
        *)
            echo "–ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ"
            ;;
    esac
}

# –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–∫–æ—Ä–æ—Å—Ç–∏ —Å–µ—Ç–∏
check_network_speed() {
    local ping_time
    ping_time=$(ping -c 3 8.8.8.8 2>/dev/null | grep "avg" | cut -d'/' -f5 | cut -d'.' -f1)
    if [ -z "$ping_time" ]; then
        echo "unknown"
        return 1
    fi
    if [ "$ping_time" -gt "$NETWORK_SPEED_THRESHOLD" ]; then
        echo "slow"
        return 1
    else
        echo "fast"
        return 0
    fi
}

# –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–¥–æ—Å—Ç—É–ø–∞ (—É–ª—É—á—à–µ–Ω–Ω–∞—è –¥–ª—è –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Å–µ—Ç–∏)
check_internet_access() {
    # –ï—Å–ª–∏ –æ–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ, —Å—á–∏—Ç–∞–µ–º —á—Ç–æ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω
    if [ "$CLOUD_SERVICE" = "none" ]; then
        return 0
    fi
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–∑–æ–≤—É—é —Å–≤—è–∑–Ω–æ—Å—Ç—å
    if ! ping -c 1 -W "$CONNECTIVITY_TIMEOUT" "8.8.8.8" >/dev/null 2>&1; then
        return 1
    fi
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –æ–±–ª–∞—á–Ω–æ–º—É —Å–µ—Ä–≤–∏—Å—É
    case "$CLOUD_SERVICE" in
        "google")
            timeout $((CONNECTIVITY_TIMEOUT * 2)) rclone about "$GOOGLE_REMOTE:" >/dev/null 2>&1
            ;;
        "yandex")
            timeout $((CONNECTIVITY_TIMEOUT * 2)) rclone about "$YANDEX_REMOTE:" >/dev/null 2>&1
            ;;
        *)
            return 0
            ;;
    esac
}

# –§—É–Ω–∫—Ü–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–∏
sync_time() {
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ RTC
    if [ -e /dev/rtc ] || [ -e /dev/rtc0 ]; then
        printf "${BLUE}üïê –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏ —Å RTC...${RESET}\n"
        if hwclock --hctosys 2>/dev/null; then
            printf "${GREEN}‚úî –í—Ä–µ–º—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å RTC${RESET}\n"
            log_message "–í—Ä–µ–º—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å RTC: $(date)"
        else
            printf "${YELLOW}‚ö† –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å RTC${RESET}\n"
            log_message "–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å RTC"
        fi
    else
        printf "${YELLOW}‚ö† RTC –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏—Å—Ç–µ–º–Ω–æ–µ –≤—Ä–µ–º—è${RESET}\n"
        log_message "RTC –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–∏—Å—Ç–µ–º–Ω–æ–µ –≤—Ä–µ–º—è: $(date)"
    fi
    # –ü–æ–ø—ã—Ç–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ NTP –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
    if check_internet_access; then
        printf "${BLUE}üåê –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏ —á–µ—Ä–µ–∑ NTP...${RESET}\n"
        if ntpdate -s time.nist.gov 2>/dev/null; then
            printf "${GREEN}‚úî –í—Ä–µ–º—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ NTP${RESET}\n"
            log_message "–í—Ä–µ–º—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ NTP: $(date)"
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º—è –≤ RTC –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
            if [ -e /dev/rtc ] || [ -e /dev/rtc0 ]; then
                hwclock --systohc 2>/dev/null && log_message "–í—Ä–µ–º—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ RTC"
            fi
        else
            printf "${YELLOW}‚ö† –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ NTP${RESET}\n"
            log_message "–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ NTP"
        fi
    else
        printf "${YELLOW}‚ö† –ù–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–∏${RESET}\n"
        log_message "–ù–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–∏"
    fi
}

# –§—É–Ω–∫—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ (–ø—Ä–æ—Å—Ç–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è arecord)
setup_mic() {
    printf "${BOLD}${BLUE}‚ñ† –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é...${RESET}\n"
    MIC="default"
    printf "${GREEN}‚úî –ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–∞—Å—Ç—Ä–æ–µ–Ω: ${YELLOW}%s${RESET}\n" "$MIC"
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ —á–µ—Ä–µ–∑ arecord
    if ! arecord -D "$MIC" -f "$SAMPLE_FORMAT" -r "$SAMPLE_RATE" -d 1 --quiet - >/dev/null 2>&1; then
        local exit_code=$?
        printf "${RED}‚úñ –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É %s (–∫–æ–¥: %d)${RESET}\n" "$MIC" "$exit_code"
        printf "${YELLOW}‚ö† –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞${RESET}\n"
        printf "${BLUE}üí° –î–æ—Å—Ç—É–ø–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ ALSA:${RESET}\n"
        arecord -l 2>/dev/null || echo "  –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤"
        handle_critical_error "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É $MIC (–∫–æ–¥: $exit_code)" "$exit_code" "mic_setup"
    fi
}

# –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –≤ –ú–ë
get_dir_size_mb() {
    local dir="$1"
    if [ -d "$dir" ]; then
        du -sm "$dir" 2>/dev/null | cut -f1
    else
        echo 0
    fi
}

# –§—É–Ω–∫—Ü–∏—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Ä–∞–∑–º–µ—Ä–∞ –æ—á–µ—Ä–µ–¥–∏
check_queue_size() {
    local pending_size
    pending_size=$(get_dir_size_mb "$PENDING_DIR")
    local usage_percent=$((pending_size * 100 / MAX_STORAGE_MB))
    if [ "$usage_percent" -gt "$QUEUE_WARNING_THRESHOLD" ]; then
        log_error "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –º–∞–ª–æ –º–µ—Å—Ç–∞: ${usage_percent}% (${pending_size}MB/${MAX_STORAGE_MB}MB)" "storage_critical" "queue"
        return 1
    elif [ "$usage_percent" -gt 60 ]; then
        log_message "–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è ${usage_percent}% —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ (${pending_size}MB/${MAX_STORAGE_MB}MB)"
    fi
    return 0
}

# –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤ –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–ª—è Pi Zero 2 W)
cleanup_old_files() {
    local pending_size
    pending_size=$(get_dir_size_mb "$PENDING_DIR")
    if [ "$pending_size" -gt "$MAX_STORAGE_MB" ]; then
        log_message "–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç —Ö—Ä–∞–Ω–∏–ª–∏—â–∞: ${pending_size}MB > ${MAX_STORAGE_MB}MB"
        # –£–¥–∞–ª—è–µ–º —Å–∞–º—ã–µ —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã –¥–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞ (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
        find "$PENDING_DIR" -name "REC_*.${AUDIO_FORMAT}" -type f -printf '%T@ %p\n' 2>/dev/null | \
            sort -n | \
            while read -r timestamp file; do
                rm -f "$file"
                log_message "–£–¥–∞–ª–µ–Ω —Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª: $file"
                pending_size=$(get_dir_size_mb "$PENDING_DIR")
                [ "$pending_size" -le "$MAX_STORAGE_MB" ] && break
            done
    fi
}

# –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –¥–ª—è Pi Zero 2 W)
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"
}

# –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫ —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
log_error() {
    local error_msg="$1"
    local error_code="${2:-unknown}"
    local context="${3:-main}"
    log_message "–û–®–ò–ë–ö–ê [$context] (–∫–æ–¥: $error_code): $error_msg"
    printf "${RED}‚úñ –û–®–ò–ë–ö–ê [$context]: $error_msg${RESET}\n" >&2
}

# –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
handle_critical_error() {
    local error_msg="$1"
    local error_code="${2:-1}"
    local context="${3:-main}"
    log_error "$error_msg" "$error_code" "$context"
    # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
    cleanup_temp_files
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ —Ñ–æ–Ω–æ–≤—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
    kill_background_jobs
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    printf "${RED}üí• –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: $error_msg${RESET}\n"
    printf "${YELLOW}üìã –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: $LOG_FILE${RESET}\n"
    exit "$error_code"
}

# –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
cleanup_temp_files() {
    # –£–¥–∞–ª—è–µ–º –º–∞—Ä–∫–µ—Ä—ã –∑–∞–ø–∏—Å–∏
    find "$OUTPUT_DIR" -name "*.recording" -type f -delete 2>/dev/null
    log_message "–í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –æ—á–∏—â–µ–Ω—ã"
}

# –§—É–Ω–∫—Ü–∏—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ñ–æ–Ω–æ–≤—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
kill_background_jobs() {
    local jobs_pids
    jobs_pids=$(jobs -p 2>/dev/null)
    if [ -n "$jobs_pids" ]; then
        log_message "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–æ–Ω–æ–≤—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤: $jobs_pids"
        echo "$jobs_pids" | xargs kill -TERM 2>/dev/null
        sleep 2
        echo "$jobs_pids" | xargs kill -KILL 2>/dev/null
    fi
}

# –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞ –ø–æ—Å–ª–µ –∑–∞–ø–∏—Å–∏
process_recorded_file() {
    local file="$1"
    local file_name="$2"
    if [ -f "$file" ]; then
        local file_size
        file_size=$(stat -c%s "$file" 2>/dev/null || echo 0)
        if [ "$file_size" -lt 1024 ]; then
            log_error "$file_name —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∏–π (${file_size} –±–∞–π—Ç): $file" "${file_name,,}_too_small" "recording"
            rm -f "$file"
        else
            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ñ–∞–π–ª
            if [ "$CLOUD_SERVICE" != "none" ]; then
                if check_internet_access && upload_to_cloud "$file"; then
                    log_message "$file_name —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω: $file"
                else
                    if ! queue_for_upload "$file"; then
                        log_error "–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å $file_name –≤ –æ—á–µ—Ä–µ–¥—å: $file" "${file_name,,}_queue_failed" "recording"
                    fi
                fi
            fi
        fi
    fi
}

# –§—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –∑–∞–ø–∏—Å–∏ —á–µ—Ä–µ–∑ arecord
start_recording() {
    local file="$1"
    local duration="$2"
    log_message "–ó–∞–ø—É—Å–∫ –∑–∞–ø–∏—Å–∏: $file (–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${duration}—Å)"
    # –ó–∞–ø—É—Å–∫–∞–µ–º arecord + ffmpeg
    case "$AUDIO_FORMAT" in
        aac)
            arecord -D "$MIC" -f "$SAMPLE_FORMAT" -r "$SAMPLE_RATE" -d "$duration" --quiet - 2>> "$LOG_FILE" | \
            ffmpeg -y -i - -c:a aac -b:a "${BITRATE}k" -ac 1 "$file" -hide_banner -loglevel error 2>> "$LOG_FILE"
            ;;
        opus)
            arecord -D "$MIC" -f "$SAMPLE_FORMAT" -r "$SAMPLE_RATE" -d "$duration" --quiet - 2>> "$LOG_FILE" | \
            ffmpeg -y -i - -c:a libopus -b:a "${BITRATE}k" -application voip -ac 1 "$file" -hide_banner -loglevel error 2>> "$LOG_FILE"
            ;;
        mp3)
            arecord -D "$MIC" -f "$SAMPLE_FORMAT" -r "$SAMPLE_RATE" -d "$duration" --quiet - 2>> "$LOG_FILE" | \
            ffmpeg -y -i - -c:a libmp3lame -b:a "${BITRATE}k" -q:a 5 -ac 1 "$file" -hide_banner -loglevel error 2>> "$LOG_FILE"
            ;;
        *)
            log_error "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∞—É–¥–∏–æ: $AUDIO_FORMAT" "invalid_audio_format" "recording"
            return 1
            ;;
    esac
    local exit_code=$?
    if [ $exit_code -ne 0 ]; then
        log_error "–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ (–∫–æ–¥: $exit_code): $file" "$exit_code" "recording"
        return 1
    fi
    log_message "–ó–∞–ø–∏—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞: $file"
    return 0
}

# –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ –≤ –æ–±–ª–∞–∫–æ (–∞–¥–∞–ø—Ç–∏–≤–Ω–∞—è –¥–ª—è –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Å–µ—Ç–∏)
upload_to_cloud() {
    local file="$1"
    local retries=0
    local cloud_target
    local exit_code
    local network_speed
    local max_retries
    local retry_delay
    cloud_target=$(get_cloud_settings)
    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É, –µ—Å–ª–∏ –æ–±–ª–∞–∫–æ –æ—Ç–∫–ª—é—á–µ–Ω–æ
    if [ "$CLOUD_SERVICE" = "none" ]; then
        return 0
    fi
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
    if [ ! -f "$file" ]; then
        log_error "–§–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω: $file" "file_not_found" "upload"
        return 1
    fi
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É
    if ! check_internet_access; then
        log_error "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏: $file" "no_internet" "upload"
        return 1
    fi
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–≥—Ä—É–∑–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏ —Å–µ—Ç–∏
    network_speed=$(check_network_speed)
    if [ "$network_speed" = "slow" ]; then
        max_retries=$SLOW_NETWORK_MAX_RETRIES
        retry_delay=$SLOW_NETWORK_RETRY_DELAY
        log_message "–ú–µ–¥–ª–µ–Ω–Ω–∞—è —Å–µ—Ç—å –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è: $file"
    else
        max_retries=$MAX_RETRIES
        retry_delay=$RETRY_DELAY
    fi
    log_message "–ù–∞—á–∞–ª–æ –≤—ã–≥—Ä—É–∑–∫–∏ –Ω–∞ $(get_cloud_name): $file (—Å–µ—Ç—å: $network_speed)"
    while [ "$retries" -lt "$max_retries" ]; do
        if rclone copy "$file" "$cloud_target" --quiet 2>/dev/null; then
            log_message "–£—Å–ø–µ—à–Ω–æ –≤—ã–≥—Ä—É–∂–µ–Ω–æ –Ω–∞ $(get_cloud_name): $file"
            if [ "$DELETE_AFTER_UPLOAD" = "true" ]; then
                if ! rm -f "$file" 2>/dev/null; then
                    log_error "–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏: $file" "delete_failed" "upload"
                else
                    log_message "–§–∞–π–ª —É–¥–∞–ª–µ–Ω: $file"
                fi
            fi
            return 0
        fi
        exit_code=$?
        retries=$((retries + 1))
        log_error "–û—à–∏–±–∫–∞ –≤—ã–≥—Ä—É–∑–∫–∏ ($retries/$max_retries) (–∫–æ–¥: $exit_code): $file" "$exit_code" "upload"
        sleep "$retry_delay"
    done
    log_error "–í—ã–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–≤–∞–ª–µ–Ω–∞ –ø–æ—Å–ª–µ $max_retries –ø–æ–ø—ã—Ç–æ–∫: $file" "upload_failed" "upload"
    return 1
}

# –§—É–Ω–∫—Ü–∏—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
upload_parallel() {
    local max_parallel="$1"
    local uploaded=0
    local failed=0
    # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏) - POSIX —Å–æ–≤–º–µ—Å—Ç–∏–º–æ
    local files
    files=$(find "$PENDING_DIR" -name "REC_*.${AUDIO_FORMAT}" -type f -exec stat -c '%Y %n' {} \; 2>/dev/null | \
        sort -nr | head -10 | cut -d' ' -f2-)
    for file in $files; do
        if [ -f "$file" ]; then
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
            if [ $(jobs -r | wc -l) -lt "$max_parallel" ]; then
                # –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –≤ —Ñ–æ–Ω–µ
                upload_to_cloud "$file" &
                uploaded=$((uploaded + 1))
            else
                # –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
                wait -n
                # –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—É—é –∑–∞–≥—Ä—É–∑–∫—É
                upload_to_cloud "$file" &
                uploaded=$((uploaded + 1))
            fi
        fi
    done
    # –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö —Ñ–æ–Ω–æ–≤—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
    wait
    log_message "–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞: –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ $uploaded —Ñ–∞–π–ª–æ–≤"
    return 0
}

# –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—á–µ—Ä–µ–¥–∏ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ (—É–ª—É—á—à–µ–Ω–Ω–∞—è –¥–ª—è –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Å–µ—Ç–∏)
process_upload_queue() {
    # –ï—Å–ª–∏ –æ–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ, –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—á–µ—Ä–µ–¥—å
    if [ "$CLOUD_SERVICE" = "none" ]; then
        return 0
    fi
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É
    if ! check_internet_access; then
        return 1
    fi
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏
    if ! check_queue_size; then
        log_error "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏, –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞" "queue_critical" "upload"
        cleanup_old_files
    fi
    printf "${BOLD}${GREEN}‚òÅ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—á–µ—Ä–µ–¥–∏ $(get_cloud_name)...${RESET}\n"
    log_message "–ù–∞—á–∞–ª–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—á–µ—Ä–µ–¥–∏ $(get_cloud_name)"
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–≥—Ä—É–∑–æ–∫ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏ —Å–µ—Ç–∏
    local network_speed
    network_speed=$(check_network_speed)
    local max_parallel
    if [ "$network_speed" = "slow" ]; then
        max_parallel=1  # –û–¥–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∞ –¥–ª—è –º–µ–¥–ª–µ–Ω–Ω–æ–π —Å–µ—Ç–∏
        log_message "–ú–µ–¥–ª–µ–Ω–Ω–∞—è —Å–µ—Ç—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É"
    else
        max_parallel=$MAX_PARALLEL_UPLOADS  # –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π —Å–µ—Ç–∏
        log_message "–ë—ã—Å—Ç—Ä–∞—è —Å–µ—Ç—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É ($max_parallel –ø–æ—Ç–æ–∫–æ–≤)"
    fi
    # –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    upload_parallel "$max_parallel"
    return 0
}

# –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è —Ñ–∞–π–ª–∞ –≤ –æ—á–µ—Ä–µ–¥—å –∑–∞–≥—Ä—É–∑–∫–∏
queue_for_upload() {
    local file="$1"
    local pending_file="$PENDING_DIR/$(basename "$file")"
    if mv "$file" "$pending_file" 2>/dev/null; then
        log_message "–§–∞–π–ª –¥–æ–±–∞–≤–ª–µ–Ω –≤ –æ—á–µ—Ä–µ–¥—å –¥–ª—è $(get_cloud_name): $pending_file"
        return 0
    else
        log_message "–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –≤ –æ—á–µ—Ä–µ–¥—å: $file"
        return 1
    fi
}

# –§—É–Ω–∫—Ü–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –ø–æ—Å–ª–µ —Å–±–æ—è –ø–∏—Ç–∞–Ω–∏—è (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –¥–ª—è Pi Zero 2 W)
recover_interrupted_files() {
    printf "${BLUE}üîÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤ –ø–æ—Å–ª–µ —Å–±–æ—è...${RESET}\n"
    log_message "–ù–∞—á–∞–ª–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤"
    local recovered=0
    local corrupted=0
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª—ã –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –ø–∞–ø–∫–µ –≤—ã–≤–æ–¥–∞
    for file in "$OUTPUT_DIR"/REC_*."$AUDIO_FORMAT"; do
        [ ! -f "$file" ] && continue
        local filename
        filename=$(basename "$file")
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è Pi Zero 2 W)
        if [ -s "$file" ]; then
            local file_size
            file_size=$(stat -c%s "$file" 2>/dev/null || echo 0)
            # –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –≤–∞–ª–∏–¥–Ω–æ–≥–æ –∞—É–¥–∏–æ—Ñ–∞–π–ª–∞ (1–ö–ë)
            if [ "$file_size" -gt 1024 ]; then
                # –ü–µ—Ä–µ–º–µ—â–∞–µ–º –≤ –æ—á–µ—Ä–µ–¥—å –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ ffprobe (—ç–∫–æ–Ω–æ–º–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤)
                if mv "$file" "$PENDING_DIR/$filename" 2>/dev/null; then
                    log_message "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Ñ–∞–π–ª: $filename"
                    recovered=$((recovered + 1))
                fi
            else
                # –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∏–π, —É–¥–∞–ª—è–µ–º
                log_message "–ù–µ–ø–æ–ª–Ω—ã–π —Ñ–∞–π–ª —É–¥–∞–ª–µ–Ω: $filename (${file_size} –±–∞–π—Ç)"
                rm -f "$file"
                corrupted=$((corrupted + 1))
            fi
        else
            # –ü—É—Å—Ç–æ–π —Ñ–∞–π–ª, —É–¥–∞–ª—è–µ–º
            log_message "–ü—É—Å—Ç–æ–π —Ñ–∞–π–ª —É–¥–∞–ª–µ–Ω: $filename"
            rm -f "$file"
            corrupted=$((corrupted + 1))
        fi
    done
    # –û—á–∏—â–∞–µ–º –æ—Å–∏—Ä–æ—Ç–µ–≤—à–∏–µ –º–∞—Ä–∫–µ—Ä—ã –∑–∞–ø–∏—Å–∏
    for marker in "$OUTPUT_DIR"/*.recording; do
        [ -f "$marker" ] && rm -f "$marker"
    done
    if [ $recovered -gt 0 ] || [ $corrupted -gt 0 ]; then
        printf "${GREEN}‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: ${YELLOW}%d${GREEN}, —É–¥–∞–ª–µ–Ω–æ: ${YELLOW}%d${RESET}\n" "$recovered" "$corrupted"
        log_message "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ: –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ=$recovered, –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–æ=$corrupted"
    else
        printf "${GREEN}‚úÖ –§–∞–π–ª–æ–≤ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–æ${RESET}\n"
    fi
}

# –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
create_recovery_marker() {
    local file="$1"
    local marker_file="${file}.recording"
    echo "$(date '+%Y-%m-%d %H:%M:%S') - –ó–∞–ø–∏—Å—å –Ω–∞—á–∞—Ç–∞" > "$marker_file"
}

# –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
remove_recovery_marker() {
    local file="$1"
    local marker_file="${file}.recording"
    rm -f "$marker_file"
}

# ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
# ‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë –ó–ê–ü–£–°–ö ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñà
# ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà

# –§—É–Ω–∫—Ü–∏—è graceful shutdown
graceful_shutdown() {
    local signal="$1"
    local exit_code=0
    printf "\n${YELLOW}üõë –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª $signal, –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã...${RESET}\n"
    log_message "–ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª $signal, –Ω–∞—á–∞–ª–æ graceful shutdown"
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ —Ñ–æ–Ω–æ–≤—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
    kill_background_jobs
    # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
    cleanup_temp_files
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    pending_count=$(find "$PENDING_DIR" -name "REC_*.${AUDIO_FORMAT}" -type f 2>/dev/null | wc -l)
    if [ "$pending_count" -gt 0 ]; then
        printf "${YELLOW}üìÅ –§–∞–π–ª–æ–≤ –≤ –æ—á–µ—Ä–µ–¥–∏ –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É: $pending_count${RESET}\n"
        log_message "–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã —Å $pending_count —Ñ–∞–π–ª–∞–º–∏ –≤ –æ—á–µ—Ä–µ–¥–∏"
    fi
    printf "${GREEN}‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã${RESET}\n"
    log_message "Graceful shutdown –∑–∞–≤–µ—Ä—à–µ–Ω"
    exit $exit_code
}

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
trap 'graceful_shutdown INT' INT
trap 'graceful_shutdown TERM' TERM
trap 'graceful_shutdown EXIT' EXIT

# –°–æ–∑–¥–∞—ë–º –ø–∞–ø–∫–∏ –≤—ã–≤–æ–¥–∞, –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
if ! mkdir -p "$OUTPUT_DIR" 2>/dev/null; then
    handle_critical_error "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É –≤—ã–≤–æ–¥–∞: $OUTPUT_DIR" 1 "init"
fi
if ! mkdir -p "$PENDING_DIR" 2>/dev/null; then
    handle_critical_error "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É –æ—á–µ—Ä–µ–¥–∏: $PENDING_DIR" 1 "init"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –∑–∞–ø–∏—Å–∏ –≤ –ø–∞–ø–∫–∏
if [ ! -w "$OUTPUT_DIR" ]; then
    handle_critical_error "–ù–µ—Ç –ø—Ä–∞–≤ –∑–∞–ø–∏—Å–∏ –≤ –ø–∞–ø–∫—É: $OUTPUT_DIR" 1 "init"
fi
if [ ! -w "$PENDING_DIR" ]; then
    handle_critical_error "–ù–µ—Ç –ø—Ä–∞–≤ –∑–∞–ø–∏—Å–∏ –≤ –ø–∞–ø–∫—É: $PENDING_DIR" 1 "init"
fi

# –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –≤—Ä–µ–º—è
sync_time

# –í—ã–±–∏—Ä–∞–µ–º –æ–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
select_cloud_service

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
setup_mic

# –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª—é–±—ã–µ —Ñ–∞–π–ª—ã, –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –ø–æ—Å–ª–µ —Å–±–æ—è –ø–∏—Ç–∞–Ω–∏—è
recover_interrupted_files

# –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–ø—É—Å–∫–µ
if [ "$CLOUD_SERVICE" != "none" ]; then
    printf "${BOLD}${GREEN}‚ñ∂ –ó–∞–ø—É—Å–∫ –∑–∞–ø–∏—Å–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ ${YELLOW}${AUDIO_FORMAT}${RESET} —Å –≤—ã–≥—Ä—É–∑–∫–æ–π –Ω–∞ $(get_cloud_name)...${RESET}\n"
else
    printf "${BOLD}${GREEN}‚ñ∂ –ó–∞–ø—É—Å–∫ –∑–∞–ø–∏—Å–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ ${YELLOW}${AUDIO_FORMAT}${RESET} (–ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ)...${RESET}\n"
fi

LAST_CONNECTIVITY_CHECK=0
IN_SCHEDULE_MODE=false

# –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –∑–∞–ø–∏—Å–∏
while true; do
    current_hour=$(date +%H)
    current_time=$(date +%s)

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
    if [ "$RECORDING_SCHEDULE_ENABLED" = "true" ]; then
        # –ü—Ä–∏–≤–æ–¥–∏–º –∫ —Ü–µ–ª—ã–º —á–∏—Å–ª–∞–º (–∑–∞—â–∏—Ç–∞ –æ—Ç –≤–µ–¥—É—â–∏—Ö –Ω—É–ª–µ–π)
        start_h=$((10#$RECORDING_START_HOUR))
        end_h=$((10#$RECORDING_END_HOUR))
        curr_h=$((10#$current_hour))

        if [ "$curr_h" -lt "$start_h" ] || [ "$curr_h" -ge "$end_h" ]; then
            # –í–Ω–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
            if [ "$IN_SCHEDULE_MODE" = "true" ]; then
                printf "${YELLOW}üïí –í—Ä–µ–º—è –∑–∞–ø–∏—Å–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–æ ($start_h:00‚Äì$end_h:00). –û–∂–∏–¥–∞–Ω–∏–µ...${RESET}\n"
                log_message "–í—ã—Ö–æ–¥ –∏–∑ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏. –û–∂–∏–¥–∞–Ω–∏–µ –¥–æ $start_h:00."
                IN_SCHEDULE_MODE=false
            fi
            sleep 60
            continue
        else
            # –í–Ω—É—Ç—Ä–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
            if [ "$IN_SCHEDULE_MODE" = "false" ]; then
                printf "${GREEN}‚ñ∂ –ù–∞—á–∞–ª–æ –∑–∞–ø–∏—Å–∏ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é ($start_h:00‚Äì$end_h:00)${RESET}\n"
                log_message "–í—Ö–æ–¥ –≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏. –ù–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç—ã."
                IN_SCHEDULE_MODE=true
            fi
        fi
    else
        IN_SCHEDULE_MODE=true  # –†–µ–∂–∏–º 24/7
    fi

    # –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—á–µ—Ä–µ–¥–∏
    if [ $((current_time - LAST_CONNECTIVITY_CHECK)) -ge "$CONNECTIVITY_CHECK_INTERVAL" ]; then
        LAST_CONNECTIVITY_CHECK="$current_time"
        if check_internet_access && [ "$CLOUD_SERVICE" != "none" ]; then
            process_upload_queue &
        elif [ "$CLOUD_SERVICE" != "none" ]; then
            pending_count=$(find "$PENDING_DIR" -name "REC_*.${AUDIO_FORMAT}" -type f 2>/dev/null | wc -l)
            printf "${YELLOW}üìÅ –§–∞–π–ª–æ–≤ –≤ –æ—á–µ—Ä–µ–¥–∏: ${pending_count}${RESET}\n"
        fi
    fi

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Å—Ç–∞ –∏ –æ—á–∏—Å—Ç–∫–∞
    check_queue_size
    cleanup_old_files

    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
    TS=$(date +"%Y%m%d_%H%M%S")
    FILE="${OUTPUT_DIR}/REC_${TS}.${AUDIO_FORMAT}"
    log_message "–ù–∞—á–∞–ª–æ –∑–∞–ø–∏—Å–∏: $FILE"

    # –ú–∞—Ä–∫–µ—Ä –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
    create_recovery_marker "$FILE"

    # –ó–∞–ø–∏—Å—å
    if ! start_recording "$FILE" "$SPLIT_TIME"; then
        remove_recovery_marker "$FILE"
        handle_critical_error "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–ø–∏—Å—å" 1 "recording"
    fi

    remove_recovery_marker "$FILE"
    process_recorded_file "$FILE" "–§–∞–π–ª"
    printf "${GREEN}‚úÖ –ó–∞–ø–∏—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞: $FILE${RESET}\n"
done
