#!/bin/bash

# ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
# ‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë –ù–ê–°–¢–†–û–ô–ö–ò ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñà
# ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
BOLD="\033[1m"
RED="\033[1;31m"
GREEN="\033[1;32m"
YELLOW="\033[1;33m"
BLUE="\033[1;34m"
RESET="\033[0m"

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –û–°–ù–û–í–ù–´–ï –ü–ê–†–ê–ú–ï–¢–†–´ –ó–ê–ü–ò–°–ò
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

SPLIT_TIME=1800               # –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (30 –º–∏–Ω—É—Ç)
OUTPUT_DIR="/root/arec"       # –ü–∞–ø–∫–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–ø–∏—Å–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
LOG_FILE="/root/arec/arec.log" # –§–∞–π–ª –¥–ª—è –∑–∞–ø–∏—Å–∏ –ª–æ–≥–æ–≤ —Ä–∞–±–æ—Ç—ã —Å–∫—Ä–∏–ø—Ç–∞
SAMPLE_RATE=48000             # –ß–∞—Å—Ç–æ—Ç–∞ –¥–∏—Å–∫—Ä–µ—Ç–∏–∑–∞—Ü–∏–∏ –∞—É–¥–∏–æ (–ì—Ü)
MIC=""                        # –ò—Å—Ç–æ—á–Ω–∏–∫ –∑–≤—É–∫–∞ (–ø—É—Å—Ç–æ = –∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ, default = –º–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –ù–ê–°–¢–†–û–ô–ö–ò –ö–û–î–ò–†–û–í–ê–ù–ò–Ø –ê–£–î–ò–û
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

AUDIO_FORMAT="opus"           # –§–æ—Ä–º–∞—Ç –∞—É–¥–∏–æ: aac, opus, mp3
BITRATE=64                    # –ë–∏—Ç—Ä–µ–π—Ç –∞—É–¥–∏–æ –≤ –∫–±–∏—Ç/—Å (–∫–∞—á–µ—Å—Ç–≤–æ –∑–≤—É–∫–∞)

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –ù–ê–°–¢–†–û–ô–ö–ò –û–ë–õ–ê–ß–ù–û–ì–û –•–†–ê–ù–ò–õ–ò–©–ê
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

CLOUD_SERVICE="yandex"        # –û–±–ª–∞—á–Ω—ã–π —Å–µ—Ä–≤–∏—Å: google, yandex, none (–±–µ–∑ –æ–±–ª–∞–∫–∞)
DELETE_AFTER_UPLOAD=true      # –£–¥–∞–ª—è—Ç—å —Ñ–∞–π–ª—ã –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –≤—ã–≥—Ä—É–∑–∫–∏
RETRY_DELAY=300               # –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏ –∑–∞–≥—Ä—É–∑–∫–∏ (—Å–µ–∫—É–Ω–¥—ã)
MAX_RETRIES=15                # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏
CONNECTIVITY_CHECK_INTERVAL=600 # –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (—Å–µ–∫—É–Ω–¥—ã)
PENDING_DIR="/root/arec/pending" # –ü–∞–ø–∫–∞ –¥–ª—è —Ñ–∞–π–ª–æ–≤ –≤ –æ—á–µ—Ä–µ–¥–∏ –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É
MAX_STORAGE_MB=40960          # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ (–ú–ë)
CONNECTIVITY_TIMEOUT=10       # –¢–∞–π–º–∞—É—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ—Ç–µ–≤–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (—Å–µ–∫—É–Ω–¥—ã)

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –ù–ê–°–¢–†–û–ô–ö–ò GOOGLE DRIVE
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

GOOGLE_REMOTE="google.drive"  # –ò–º—è —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –≤ rclone
GOOGLE_DIR="/Recordings"      # –ü–∞–ø–∫–∞ –Ω–∞ Google Drive –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –ù–ê–°–¢–†–û–ô–ö–ò –Ø–ù–î–ï–ö–°.–î–ò–°–ö
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

YANDEX_REMOTE="yandex.disk"   # –ò–º—è —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –≤ rclone
YANDEX_DIR="/Recordings"      # –ü–∞–ø–∫–∞ –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏

# ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
# ‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë –§–£–ù–ö–¶–ò–ò ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñà
# ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà

# –§—É–Ω–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ –æ–±–ª–∞—á–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö)
select_cloud_service() {
    if [ -n "$CLOUD_SERVICE" ]; then
        printf "${GREEN}‚úî –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å: $(get_cloud_name)${RESET}\n"
        return
    fi
    
    printf "${BOLD}${BLUE}‚òÅ –í—ã–±–µ—Ä–∏—Ç–µ –æ–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ:${RESET}\n"
    printf "${YELLOW}1)${RESET} Google Drive\n"
    printf "${YELLOW}2)${RESET} –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫\n"
    printf "${YELLOW}3)${RESET} –ë–µ–∑ –æ–±–ª–∞—á–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞\n"
    printf "\n${BOLD}–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä (1-3): ${RESET}"
    
    while true; do
        read -r choice
        case "$choice" in
            1)
                CLOUD_SERVICE="google"
                printf "${GREEN}‚úî –í—ã–±—Ä–∞–Ω Google Drive${RESET}\n"
                break
                ;;
            2)
                CLOUD_SERVICE="yandex"
                printf "${GREEN}‚úî –í—ã–±—Ä–∞–Ω –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫${RESET}\n"
                break
                ;;
            3)
                CLOUD_SERVICE="none"
                printf "${GREEN}‚úî –û–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ${RESET}\n"
                break
                ;;
            *)
                printf "${RED}‚úñ –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä. –í–≤–µ–¥–∏—Ç–µ 1, 2 –∏–ª–∏ 3: ${RESET}"
                ;;
        esac
    done
}

# –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –æ–±–ª–∞—á–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
get_cloud_settings() {
    case "$CLOUD_SERVICE" in
        "google")
            echo "$GOOGLE_REMOTE:$GOOGLE_DIR"
            ;;
        "yandex")
            echo "$YANDEX_REMOTE:$YANDEX_DIR"
            ;;
        *)
            echo ""
            ;;
    esac
}

# –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–º–µ–Ω–∏ –æ–±–ª–∞—á–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
get_cloud_name() {
    case "$CLOUD_SERVICE" in
        "google")
            echo "Google Drive"
            ;;
        "yandex")
            echo "–Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫"
            ;;
        *)
            echo "–ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ"
            ;;
    esac
}

# –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–¥–æ—Å—Ç—É–ø–∞ (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –¥–ª—è Pi Zero 2 W)
check_internet_access() {
    # –ï—Å–ª–∏ –æ–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ, —Å—á–∏—Ç–∞–µ–º —á—Ç–æ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω
    if [ "$CLOUD_SERVICE" = "none" ]; then
        return 0
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–∑–æ–≤—É—é —Å–≤—è–∑–Ω–æ—Å—Ç—å
    if ! ping -c 1 -W "$CONNECTIVITY_TIMEOUT" "8.8.8.8" >/dev/null 2>&1; then
        return 1
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –æ–±–ª–∞—á–Ω–æ–º—É —Å–µ—Ä–≤–∏—Å—É
    case "$CLOUD_SERVICE" in
        "google")
            timeout $((CONNECTIVITY_TIMEOUT * 2)) rclone about "$GOOGLE_REMOTE:" >/dev/null 2>&1
            ;;
        "yandex")
            timeout $((CONNECTIVITY_TIMEOUT * 2)) rclone about "$YANDEX_REMOTE:" >/dev/null 2>&1
            ;;
        *)
            return 0
            ;;
    esac
}

# –§—É–Ω–∫—Ü–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–∏
sync_time() {
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ RTC
    if [ -e /dev/rtc ] || [ -e /dev/rtc0 ]; then
        printf "${BLUE}üïê –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏ —Å RTC...${RESET}\n"
        if hwclock --hctosys 2>/dev/null; then
            printf "${GREEN}‚úî –í—Ä–µ–º—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å RTC${RESET}\n"
            log_message "–í—Ä–µ–º—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å RTC: $(date)"
        else
            printf "${YELLOW}‚ö† –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å RTC${RESET}\n"
            log_message "–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å RTC"
        fi
    else
        printf "${YELLOW}‚ö† RTC –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏—Å—Ç–µ–º–Ω–æ–µ –≤—Ä–µ–º—è${RESET}\n"
        log_message "RTC –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–∏—Å—Ç–µ–º–Ω–æ–µ –≤—Ä–µ–º—è: $(date)"
    fi
    
    # –ü–æ–ø—ã—Ç–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ NTP –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
    if check_internet_access; then
        printf "${BLUE}üåê –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏ —á–µ—Ä–µ–∑ NTP...${RESET}\n"
        if ntpdate -s time.nist.gov 2>/dev/null; then
            printf "${GREEN}‚úî –í—Ä–µ–º—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ NTP${RESET}\n"
            log_message "–í—Ä–µ–º—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ NTP: $(date)"
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º—è –≤ RTC –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
            if [ -e /dev/rtc ] || [ -e /dev/rtc0 ]; then
                hwclock --systohc 2>/dev/null && log_message "–í—Ä–µ–º—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ RTC"
            fi
        else
            printf "${YELLOW}‚ö† –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ NTP${RESET}\n"
            log_message "–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ NTP"
        fi
    else
        printf "${YELLOW}‚ö† –ù–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–∏${RESET}\n"
        log_message "–ù–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–∏"
    fi
}

# –§—É–Ω–∫—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ (–∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–ª—è Pi Zero 2 W)
setup_mic() {
    # –ó–∞–ø—É—Å–∫–∞–µ–º PulseAudio –µ—Å–ª–∏ –Ω–µ –∑–∞–ø—É—â–µ–Ω
    if ! pulseaudio --check >/dev/null 2>&1; then
        printf "${BLUE}üîß –ó–∞–ø—É—Å–∫ PulseAudio...${RESET}\n"
        pulseaudio --start >/dev/null 2>&1
        sleep 1
    fi
    
    # –ï—Å–ª–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω —É–∂–µ –∑–∞–¥–∞–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
    if [ -n "$MIC" ]; then
        printf "${GREEN}‚úî –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–∏–∫—Ä–æ—Ñ–æ–Ω: ${YELLOW}%s${RESET}\n" "$MIC"
    else
        # –ò—â–µ–º BY-LM40 –º–∏–∫—Ä–æ—Ñ–æ–Ω –≤ PulseAudio
        PULSE_SOURCE=$(pactl list sources short | grep "BY-LM40" | awk '{print $2}' | head -1)
        if [ -n "$PULSE_SOURCE" ]; then
            MIC="$PULSE_SOURCE"
            printf "${GREEN}‚úî BY-LM40 –º–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–∞–π–¥–µ–Ω –≤ PulseAudio: ${YELLOW}%s${RESET}\n" "$MIC"
        else
            MIC="default"
            printf "${YELLOW}‚ö† BY-LM40 –º–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è: ${YELLOW}%s${RESET}\n" "$MIC"
        fi
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ —á–µ—Ä–µ–∑ PulseAudio
    if ! ffmpeg -f pulse -i "$MIC" -t 1 -f null - 2>/dev/null; then
        printf "${RED}‚úñ –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É %s${RESET}\n" "$MIC"
        printf "${YELLOW}‚ö† –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞${RESET}\n"
        printf "${BLUE}üí° –î–æ—Å—Ç—É–ø–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ PulseAudio:${RESET}\n"
        pactl list sources short 2>/dev/null || echo "  –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤"
        exit 1
    fi
}

# –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –≤ –ú–ë
get_dir_size_mb() {
    local dir="$1"
    if [ -d "$dir" ]; then
        du -sm "$dir" 2>/dev/null | cut -f1
    else
        echo 0
    fi
}

# –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤ –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–ª—è Pi Zero 2 W)
cleanup_old_files() {
    local pending_size
    pending_size=$(get_dir_size_mb "$PENDING_DIR")
    
    if [ "$pending_size" -gt "$MAX_STORAGE_MB" ]; then
        log_message "–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç —Ö—Ä–∞–Ω–∏–ª–∏—â–∞: ${pending_size}MB > ${MAX_STORAGE_MB}MB"
        # –£–¥–∞–ª—è–µ–º —Å–∞–º—ã–µ —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã –¥–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞ (Linux –≤–µ—Ä—Å–∏—è –¥–ª—è Pi)
        find "$PENDING_DIR" -name "REC_*.${AUDIO_FORMAT}" -type f -exec stat -c '%Y %n' {} \; 2>/dev/null | \
            sort -n | \
            while read -r timestamp file; do
                rm -f "$file"
                log_message "–£–¥–∞–ª–µ–Ω —Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª: $file"
                pending_size=$(get_dir_size_mb "$PENDING_DIR")
                [ "$pending_size" -le "$MAX_STORAGE_MB" ] && break
            done
    fi
}

# –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –¥–ª—è Pi Zero 2 W)
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"
}


# –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∑–∞–ø–∏—Å–∏ (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –¥–ª—è Pi Zero 2 W)
show_progress() {
    local duration=$1 start=$(date +%s)
    while true; do
        elapsed=$(($(date +%s)-start))
        [ $elapsed -ge $duration ] && break
        percent=$((elapsed*100/duration))
        # –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å (–º–µ–Ω—å—à–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–π)
        printf "\r${BOLD}${BLUE}‚åõ ${GREEN}%3d%%${RESET}" $percent
        sleep 5  # –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥ –≤–º–µ—Å—Ç–æ 1
    done
    printf "\r\033[K" # –û—á–∏—â–∞–µ–º —Å—Ç—Ä–æ–∫—É –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
}

# –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ –≤ –æ–±–ª–∞–∫–æ
upload_to_cloud() {
    local file="$1"
    local retries=0
    local cloud_target
    cloud_target=$(get_cloud_settings)

    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É, –µ—Å–ª–∏ –æ–±–ª–∞–∫–æ –æ—Ç–∫–ª—é—á–µ–Ω–æ
    if [ "$CLOUD_SERVICE" = "none" ]; then
        return 0
    fi

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É
    if ! check_internet_access; then
        log_message "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É: $file"
        return 1
    fi

    log_message "–ù–∞—á–∞–ª–æ –≤—ã–≥—Ä—É–∑–∫–∏ –Ω–∞ $(get_cloud_name): $file"
    while [ "$retries" -lt "$MAX_RETRIES" ]; do
        if rclone copy "$file" "$cloud_target" --quiet; then
            log_message "–£—Å–ø–µ—à–Ω–æ –≤—ã–≥—Ä—É–∂–µ–Ω–æ –Ω–∞ $(get_cloud_name): $file"
            if [ "$DELETE_AFTER_UPLOAD" = "true" ]; then
                rm -f "$file" && log_message "–§–∞–π–ª —É–¥–∞–ª–µ–Ω: $file"
            fi
            return 0
        fi
        retries=$((retries + 1))
        log_message "–û—à–∏–±–∫–∞ –≤—ã–≥—Ä—É–∑–∫–∏ ($retries/$MAX_RETRIES): $file"
        sleep "$RETRY_DELAY"
    done
    log_message "–í—ã–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–≤–∞–ª–µ–Ω–∞: $file"
    return 1
}

# –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—á–µ—Ä–µ–¥–∏ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
process_upload_queue() {
    # –ï—Å–ª–∏ –æ–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ, –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—á–µ—Ä–µ–¥—å
    if [ "$CLOUD_SERVICE" = "none" ]; then
        return 0
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É
    if ! check_internet_access; then
        return 1
    fi

    printf "${BOLD}${GREEN}‚òÅ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—á–µ—Ä–µ–¥–∏ $(get_cloud_name)...${RESET}\n"
    log_message "–ù–∞—á–∞–ª–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—á–µ—Ä–µ–¥–∏ $(get_cloud_name)"
    
    local uploaded=0
    local failed=0
    
    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ñ–∞–π–ª—ã –ø–æ –ø–æ—Ä—è–¥–∫—É
    find "$PENDING_DIR" -name "REC_*.${AUDIO_FORMAT}" -type f -exec stat -c '%Y %n' {} \; 2>/dev/null | \
        sort -n | while read -r timestamp file; do
        if [ -f "$file" ]; then
            if upload_to_cloud "$file"; then
                uploaded=$((uploaded + 1))
            else
                failed=$((failed + 1))
                break
            fi
        fi
    done
    
    log_message "–û—á–µ—Ä–µ–¥—å –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞: —É—Å–ø–µ—à–Ω–æ $uploaded, –æ—à–∏–±–∫–∏ $failed"
    return 0
}

# –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è —Ñ–∞–π–ª–∞ –≤ –æ—á–µ—Ä–µ–¥—å –∑–∞–≥—Ä—É–∑–∫–∏
queue_for_upload() {
    local file="$1"
    local pending_file="$PENDING_DIR/$(basename "$file")"
    
    if mv "$file" "$pending_file" 2>/dev/null; then
        log_message "–§–∞–π–ª –¥–æ–±–∞–≤–ª–µ–Ω –≤ –æ—á–µ—Ä–µ–¥—å –¥–ª—è $(get_cloud_name): $pending_file"
        return 0
    else
        log_message "–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –≤ –æ—á–µ—Ä–µ–¥—å: $file"
        return 1
    fi
}

# –§—É–Ω–∫—Ü–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –ø–æ—Å–ª–µ —Å–±–æ—è –ø–∏—Ç–∞–Ω–∏—è (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –¥–ª—è Pi Zero 2 W)
recover_interrupted_files() {
    printf "${BLUE}üîÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤ –ø–æ—Å–ª–µ —Å–±–æ—è...${RESET}\n"
    log_message "–ù–∞—á–∞–ª–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤"
    
    local recovered=0
    local corrupted=0
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª—ã –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –ø–∞–ø–∫–µ –≤—ã–≤–æ–¥–∞
    for file in "$OUTPUT_DIR"/REC_*."$AUDIO_FORMAT"; do
        [ ! -f "$file" ] && continue
        
        local filename
        filename=$(basename "$file")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è Pi Zero 2 W)
        if [ -s "$file" ]; then
            local file_size
            file_size=$(stat -c%s "$file" 2>/dev/null || echo 0)
            
            # –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –≤–∞–ª–∏–¥–Ω–æ–≥–æ –∞—É–¥–∏–æ—Ñ–∞–π–ª–∞ (1–ö–ë)
            if [ "$file_size" -gt 1024 ]; then
                # –ü–µ—Ä–µ–º–µ—â–∞–µ–º –≤ –æ—á–µ—Ä–µ–¥—å –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ ffprobe (—ç–∫–æ–Ω–æ–º–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤)
                if mv "$file" "$PENDING_DIR/$filename" 2>/dev/null; then
                    log_message "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Ñ–∞–π–ª: $filename"
                    recovered=$((recovered + 1))
                fi
            else
                # –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∏–π, —É–¥–∞–ª—è–µ–º
                log_message "–ù–µ–ø–æ–ª–Ω—ã–π —Ñ–∞–π–ª —É–¥–∞–ª–µ–Ω: $filename (${file_size} –±–∞–π—Ç)"
                rm -f "$file"
                corrupted=$((corrupted + 1))
            fi
        else
            # –ü—É—Å—Ç–æ–π —Ñ–∞–π–ª, —É–¥–∞–ª—è–µ–º
            log_message "–ü—É—Å—Ç–æ–π —Ñ–∞–π–ª —É–¥–∞–ª–µ–Ω: $filename"
            rm -f "$file"
            corrupted=$((corrupted + 1))
        fi
    done
    
    # –û—á–∏—â–∞–µ–º –æ—Å–∏—Ä–æ—Ç–µ–≤—à–∏–µ –º–∞—Ä–∫–µ—Ä—ã –∑–∞–ø–∏—Å–∏
    for marker in "$OUTPUT_DIR"/*.recording; do
        [ -f "$marker" ] && rm -f "$marker"
    done
    
    if [ $recovered -gt 0 ] || [ $corrupted -gt 0 ]; then
        printf "${GREEN}‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: ${YELLOW}%d${GREEN}, —É–¥–∞–ª–µ–Ω–æ: ${YELLOW}%d${RESET}\n" "$recovered" "$corrupted"
        log_message "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ: –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ=$recovered, –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–æ=$corrupted"
    else
        printf "${GREEN}‚úÖ –§–∞–π–ª–æ–≤ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–æ${RESET}\n"
    fi
}

# –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
create_recovery_marker() {
    local file="$1"
    local marker_file="${file}.recording"
    echo "$(date '+%Y-%m-%d %H:%M:%S') - –ó–∞–ø–∏—Å—å –Ω–∞—á–∞—Ç–∞" > "$marker_file"
}

# –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
remove_recovery_marker() {
    local file="$1"
    local marker_file="${file}.recording"
    rm -f "$marker_file"
}

# ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
# ‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë –ó–ê–ü–£–°–ö ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñà
# ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ INT (Ctrl+C) –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è - POSIX —Å–æ–≤–º–µ—Å—Ç–∏–º–æ
trap 'kill $(jobs -p) 2>/dev/null; printf "\n${RED}‚úñ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã...${RESET}\n"; exit' INT

# –°–æ–∑–¥–∞—ë–º –ø–∞–ø–∫–∏ –≤—ã–≤–æ–¥–∞, –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
mkdir -p "$OUTPUT_DIR"
mkdir -p "$PENDING_DIR"

# –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –≤—Ä–µ–º—è
sync_time

# –í—ã–±–∏—Ä–∞–µ–º –æ–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
select_cloud_service

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
setup_mic

# –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª—é–±—ã–µ —Ñ–∞–π–ª—ã, –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –ø–æ—Å–ª–µ —Å–±–æ—è –ø–∏—Ç–∞–Ω–∏—è
recover_interrupted_files

# –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–ø—É—Å–∫–µ
if [ "$CLOUD_SERVICE" != "none" ]; then
    printf "${BOLD}${GREEN}‚ñ∂ –ó–∞–ø—É—Å–∫ –∑–∞–ø–∏—Å–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ ${YELLOW}${AUDIO_FORMAT}${RESET} —Å –≤—ã–≥—Ä—É–∑–∫–æ–π –Ω–∞ $(get_cloud_name)...${RESET}\n"
else
    printf "${BOLD}${GREEN}‚ñ∂ –ó–∞–ø—É—Å–∫ –∑–∞–ø–∏—Å–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ ${YELLOW}${AUDIO_FORMAT}${RESET} (–ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ)...${RESET}\n"
fi

LAST_CONNECTIVITY_CHECK=0

# –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –∑–∞–ø–∏—Å–∏
while true; do
    # –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—á–µ—Ä–µ–¥—å
    current_time=$(date +%s)
    if [ $((current_time - LAST_CONNECTIVITY_CHECK)) -ge "$CONNECTIVITY_CHECK_INTERVAL" ]; then
        LAST_CONNECTIVITY_CHECK="$current_time"
        
        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—á–µ—Ä–µ–¥—å –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
        if check_internet_access && [ "$CLOUD_SERVICE" != "none" ]; then
            process_upload_queue &
        elif [ "$CLOUD_SERVICE" != "none" ]; then
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –æ—á–µ—Ä–µ–¥–∏
            local pending_count
            pending_count=$(find "$PENDING_DIR" -name "REC_*.${AUDIO_FORMAT}" -type f | wc -l)
            printf "${YELLOW}üìÅ –§–∞–π–ª–æ–≤ –≤ –æ—á–µ—Ä–µ–¥–∏: ${pending_count}${RESET}\n"
        fi
    fi


    # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
    cleanup_old_files

    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –º–µ—Ç–∫—É –∏ –∏–º—è —Ñ–∞–π–ª–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º
    TS=$(date +"%Y%m%d_%H%M%S")
    FILE="${OUTPUT_DIR}/REC_${TS}.${AUDIO_FORMAT}"

    log_message "–ù–∞—á–∞–ª–æ –∑–∞–ø–∏—Å–∏: $FILE"

    # –°–æ–∑–¥–∞—ë–º –º–∞—Ä–∫–µ—Ä –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –∑–∞–ø–∏—Å–∏
    create_recovery_marker "$FILE"

    # –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–ø–∏—Å—å –∏ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ ffmpeg —Å PulseAudio
    # ffmpeg –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –∑–≤—É–∫ —á–µ—Ä–µ–∑ PulseAudio
    case "$AUDIO_FORMAT" in
        aac)
            ffmpeg -y -f pulse -i "$MIC" -t "$SPLIT_TIME" -c:a aac -b:a "${BITRATE}k" -ar "$SAMPLE_RATE" "$FILE" -hide_banner -loglevel error 2>> "$LOG_FILE" &
            ;;
        opus)
            ffmpeg -y -f pulse -i "$MIC" -t "$SPLIT_TIME" -c:a libopus -b:a "${BITRATE}k" -application voip -ar "$SAMPLE_RATE" "$FILE" -hide_banner -loglevel error 2>> "$LOG_FILE" &
            ;;
        mp3)
            ffmpeg -y -f pulse -i "$MIC" -t "$SPLIT_TIME" -c:a libmp3lame -b:a "${BITRATE}k" -q:a 5 -ar "$SAMPLE_RATE" "$FILE" -hide_banner -loglevel error 2>> "$LOG_FILE" &
            ;;
        *)
            printf "${RED}‚úñ –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∞—É–¥–∏–æ: %s. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ aac, opus –∏–ª–∏ mp3.${RESET}\n" "$AUDIO_FORMAT"
            log_message "–û—à–∏–±–∫–∞: –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∞—É–¥–∏–æ: $AUDIO_FORMAT"
            remove_recovery_marker "$FILE"
            exit 1
            ;;
    esac

    # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞
    show_progress "$SPLIT_TIME"
    wait # –û–∂–∏–¥–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞ ffmpeg

    # –£–¥–∞–ª—è–µ–º –º–∞—Ä–∫–µ—Ä –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–ø–∏—Å–∏
    remove_recovery_marker "$FILE"

    log_message "–ó–∞–ø–∏—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞: $FILE"

    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–∞–ø–∏—Å–∞–Ω–Ω—ã–π —Ñ–∞–π–ª
    if [ "$CLOUD_SERVICE" != "none" ] && [ -f "$FILE" ]; then
        # –ü–æ–ø—ã—Ç–∫–∞ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
        if check_internet_access && upload_to_cloud "$FILE"; then
            log_message "–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω: $FILE"
        else
            # –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª –≤ –æ—á–µ—Ä–µ–¥—å
            queue_for_upload "$FILE"
        fi
    elif [ ! -f "$FILE" ]; then
        log_message "–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ—Å–ª–µ –∑–∞–ø–∏—Å–∏: $FILE"
    fi
done
